<!DOCTYPE html>
<html>
<head>
    <title>Adaptiera Chat Widget</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f5f5f5; 
        }
        .chat-container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .chat-header {
            background: #2196f3;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        #messages { 
            height: 400px; 
            overflow-y: auto; 
            padding: 20px; 
            background: #fafafa; 
        }
        .message { 
            margin: 10px 0; 
            padding: 10px 15px; 
            border-radius: 8px; 
            max-width: 80%; 
        }
        .user { 
            background: #e3f2fd; 
            margin-left: auto; 
            text-align: right; 
        }
        .agent { 
            background: #f1f8e9; 
            margin-right: auto; 
        }
        .input-container {
            display: flex;
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }
        #user-input { 
            flex: 1; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            resize: none; 
            font-family: inherit;
        }
        #send-btn { 
            margin-left: 10px; 
            padding: 12px 20px; 
            background: #2196f3; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
        }
        #send-btn:hover { background: #1976d2; }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }
        .connection-status {
            padding: 10px;
            text-align: center;
            background: #fff3cd;
            color: #856404;
            border-top: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            ü§ñ Agente de RRHH - Adaptiera
        </div>
        <div id="messages"></div>
        <div class="input-container">
            <textarea id="user-input" placeholder="Escribe tu respuesta..." rows="2"></textarea>
            <button id="send-btn" onclick="sendMessage()">Enviar</button>
        </div>
        <div id="connection-status" class="connection-status" style="display: none;">
            Conectando al servidor...
        </div>
    </div>

    <script>
        // Obtener par√°metros de URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobOffer = urlParams.get('job-offer');
        const token = urlParams.get('token');
        
        // Detectar autom√°ticamente la URL del WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}/chat/new_session`;
        
        console.log('Conectando a:', wsUrl);
        
        let ws = null;
        let isConnected = false;
        
        function connectWebSocket() {
            const statusEl = document.getElementById('connection-status');
            statusEl.style.display = 'block';
            statusEl.textContent = 'Conectando al servidor...';
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket conectado');
                isConnected = true;
                statusEl.style.display = 'none';
                document.getElementById('send-btn').disabled = false;
                
                // Inicializar sesi√≥n con job offer si est√° disponible
                if (jobOffer) {
                    ws.send(JSON.stringify({
                        type: 'init_session',
                        job_offer: jobOffer
                    }));
                }
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'agent_message') {
                    addMessage('agent', data.content);
                }
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket desconectado');
                isConnected = false;
                document.getElementById('send-btn').disabled = true;
                statusEl.style.display = 'block';
                statusEl.textContent = 'Conexi√≥n perdida. Intentando reconectar...';
                
                // Reconectar despu√©s de 3 segundos
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('Error de WebSocket:', error);
                statusEl.style.display = 'block';
                statusEl.textContent = 'Error de conexi√≥n';
            };
        }
        
        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (message && isConnected) {
                addMessage('user', message);
                
                ws.send(JSON.stringify({
                    type: 'user_message',
                    content: message
                }));
                
                input.value = '';
            }
        }
        
        function addMessage(role, content) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<strong>${role === 'user' ? 'üë§ T√∫' : 'ü§ñ Agente'}:</strong> ${content}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        // Permitir enviar con Enter
        document.getElementById('user-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Conectar al cargar la p√°gina
        document.getElementById('send-btn').disabled = true;
        connectWebSocket();
    </script>
</body>
</html>